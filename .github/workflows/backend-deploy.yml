name: Backend CI & Deploy (OVH)

on:
  push:
    branches: [dev, main]
    paths:
      - "task-manager-back/**"
      - "docker-compose.prod.yml"
      - ".github/workflows/backend-deploy.yml"
  pull_request:
    branches: [dev, main]
    paths:
      - "task-manager-back/**"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: backend-ci
  cancel-in-progress: false

jobs:
  ci:
    name: Build backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Make mvnw executable (Linux)
        working-directory: task-manager-back
        run: |
          sed -i 's/\r$//' mvnw
          chmod +x mvnw

      - name: Build (skip tests)
        working-directory: task-manager-back
        run: ./mvnw -B -ntp -DskipTests package

  deploy:
    name: Deploy backend on OVH (SSH)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: ci

    # Empêche backend+frontend deploy de tourner en même temps
    concurrency:
      group: ovh-prod-deploy
      cancel-in-progress: false

    steps:
      - name: Deploy (git pull + docker compose up)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.OVH_HOST }}
          username: ${{ secrets.OVH_USER }}
          key: ${{ secrets.OVH_SSH_KEY }}
          port: ${{ secrets.OVH_SSH_PORT }}
          script: |
            set -euo pipefail

            REPO_DIR="/srv/tasukeru/src/taskmanager"

            # Compose: on tente d'abord un répertoire "compose", sinon le repo
            if [ -f "/srv/tasukeru/compose/docker-compose.prod.yml" ]; then
              COMPOSE_DIR="/srv/tasukeru/compose"
              COMPOSE_FILE="docker-compose.prod.yml"
            elif [ -f "$REPO_DIR/docker-compose.prod.yml" ]; then
              COMPOSE_DIR="$REPO_DIR"
              COMPOSE_FILE="docker-compose.prod.yml"
            else
              echo "::error::docker-compose.prod.yml introuvable (ni /srv/tasukeru/compose, ni dans $REPO_DIR)"
              exit 1
            fi

            echo "[backend] REPO_DIR=$REPO_DIR"
            echo "[backend] COMPOSE_DIR=$COMPOSE_DIR"
            echo "[backend] COMPOSE_FILE=$COMPOSE_FILE"

            test -d "$REPO_DIR" || { echo "::error::REPO_DIR not found: $REPO_DIR"; exit 1; }
            test -f "$COMPOSE_DIR/$COMPOSE_FILE" || { echo "::error::Compose file not found: $COMPOSE_DIR/$COMPOSE_FILE"; exit 1; }

            command -v docker >/dev/null 2>&1 || { echo "::error::docker not installed on server"; exit 1; }
            docker compose version >/dev/null 2>&1 || { echo "::error::docker compose not available on server"; exit 1; }

            cd "$REPO_DIR"
            git fetch --prune origin
            git checkout -B main origin/main
            git pull --ff-only origin main

            cd "$COMPOSE_DIR"
            docker compose -f "$COMPOSE_FILE" up -d --build --remove-orphans api
            docker compose -f "$COMPOSE_FILE" ps

            if command -v curl >/dev/null 2>&1; then
              curl -fsS http://127.0.0.1:8080/actuator/health >/dev/null
            fi

            echo "Backend OK"
