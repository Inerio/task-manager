<!-- Global confirmation dialog and alert system -->
<app-confirm-dialog></app-confirm-dialog>
<app-alert></app-alert>

<div class="header">
  <h1>Task Manager</h1>
  <button class="delete-btn" (click)="deleteAllTasks()">🗑️</button>
</div>

<div class="task-columns">
  @for (list of lists(); track list.id; let idx = $index) {
  <div
    class="column-draggable"
    [class.is-dragged]="draggedListId() === list.id"
    [class.drag-over]="dragOverIndex() === idx && draggedListId() !== null"
  >
    <!-- Header drag handle + actions -->
    <div
      class="column-header"
      draggable="true"
      (dragstart)="onColumnDragStart(list.id!, idx, $event)"
      (dragenter)="onColumnDragEnter(idx, $event)"
      (dragover)="onColumnDragOver(idx, $event)"
      (drop)="onColumnDrop($event)"
      (dragend)="onColumnDragEnd()"
    >
      <!-- Croix stylée à gauche -->
      <button
        class="btn-close-list styled-x-btn"
        (click)="deleteList(list.id!, list.name)"
        title="Supprimer la colonne"
        aria-label="Supprimer cette liste"
      >
        <img src="svg/x.svg" alt="Fermer" width="17" height="17" />
      </button>

      <!-- Edition du titre inline -->
      @if (!isEditingTitle(list)) {
      <span
        class="list-title"
        (click)="startEditTitle(list)"
        tabindex="0"
        (keydown.enter)="startEditTitle(list)"
        (keydown.space)="startEditTitle(list)"
        title="Renommer cette liste"
      >
        {{ list.name }}
      </span>
      } @else {
      <input
        id="edit-list-title-{{ list.id }}"
        class="list-title-input"
        type="text"
        [value]="editingTitleValue()"
        (input)="onEditTitleInput($event)"
        (blur)="saveTitleEdit(list)"
        (keydown.enter)="saveTitleEdit(list)"
        (keydown.escape)="cancelTitleEdit()"
        maxlength="60"
        required
      />
      }

      <!-- Poubelle à droite, stylée -->
      <button
        class="btn-delete-column styled-trash-btn"
        (click)="deleteAllInColumn(list.id!, list.name)"
        title="Supprimer toutes les tâches de cette colonne"
      >
        <img src="/svg/trash.svg" alt="Vider" width="19" height="19" />
      </button>
    </div>
    <!-- Liste des tâches + ajout tâche -->
    <app-task-list [listId]="list.id!" [title]="list.name"></app-task-list>
  </div>
  }

  <!-- "Add new list" column -->
  @if (lists().length < MAX_LISTS) {
  <div class="add-list-column">
    @if (!showAddListForm) {
    <button class="add-list-btn" (click)="showAddListForm = true">
      + Add List
    </button>
    } @else {
    <div class="add-list-form">
      <input
        type="text"
        [value]="newListName()"
        (input)="onListNameInput($event)"
        placeholder="New list name"
        required
        autofocus
      />
      <button (click)="addList()">Add</button>
      <button (click)="showAddListForm = false">Cancel</button>
      @if (addListError()) {
      <div class="add-list-error">{{ addListError() }}</div>
      }
    </div>
    }
  </div>
  }
</div>
