<div
  class="task-kanbanColumn"
  [class.task-drag-active]="isTaskDragActive()"
  (dragenter)="onColumnDragEnter($event)"
  (dragleave)="onColumnDragLeave($event)"
>
  <div class="task-dropzone-column">
    <!-- Add button always on top -->
    <button type="button" (click)="openForm()" class="add-btn">
      + {{ "task.add" | transloco }}
    </button>

    @if (showForm()) {
    <div
      class="task-form-wrapper"
      (mousedown)="$event.stopPropagation()"
      (click)="$event.stopPropagation()"
    >
      <app-task-form
        [task]="{ kanbanColumnId: kanbanColumnId, title: '' }"
        (save)="handleTaskFormSave($event)"
        (cancel)="handleTaskFormCancel()"
      ></app-task-form>
    </div>
    }

    <!-- ===== Non-empty column: head slice + (optional) top preview + tasks + tail slice ===== -->
    @if (filteredTasks().length > 0) {

    <!-- TOP ZONE: persistent spacer + head slice (no placeholder here) -->
    <div class="head-zone">
      <div class="head-spacer" aria-hidden="true"></div>

      <div
        class="drop-slice head-slice"
        [class.active]="sliceIsActive(0)"
        (dragover)="onSliceDragOver($event, 0)"
        (drop)="onSliceDrop($event, 0)"
        aria-dropeffect="move"
      ></div>
    </div>

    <!-- Top placeholder rendered OUTSIDE head-zone so it gets a normal bottom gap -->
    @if (dragOverIndex() === 0) {
    <div
      class="task-placeholder open"
      [style.--ph.px]="placeholderHeight()"
      aria-hidden="true"
    >
      @if (ghostTask()) {
      <app-task [task]="ghostTask()!"></app-task>
      }
    </div>
    }

    <!-- Inter-task slices + live placeholder -->
    @for (task of filteredTasks(); track trackById($index, task); let idx =
    $index) {
    <div class="task-row">
      <!-- Slice before current card (index = idx) -->
      <div
        class="drop-slice slice-before"
        [class.active]="sliceIsActive(idx)"
        (dragover)="onSliceDragOver($event, idx)"
        (drop)="onSliceDrop($event, idx)"
        aria-dropeffect="move"
      ></div>

      <app-task [task]="task"></app-task>

      <!-- Live placeholder AFTER this card (index = idx + 1) -->
      @if (dragOverIndex() === idx + 1) {
      <div
        class="task-placeholder open"
        [style.--ph.px]="placeholderHeight()"
        aria-hidden="true"
      >
        @if (ghostTask()) {
        <app-task [task]="ghostTask()!"></app-task>
        }
      </div>
      }

      <!-- Slice after current card (index = idx + 1) -->
      <div
        class="drop-slice slice-after"
        [class.active]="sliceIsActive(idx + 1)"
        (dragover)="onSliceDragOver($event, idx + 1)"
        (drop)="onSliceDrop($event, idx + 1)"
        aria-dropeffect="move"
      ></div>
    </div>
    }

    <!-- Tail slice to allow "append" under the last card (index = length) -->
    <div
      class="drop-slice tail-slice"
      [class.active]="sliceIsActive(filteredTasks().length)"
      (dragover)="onSliceDragOver($event, filteredTasks().length)"
      (drop)="onSliceDrop($event, filteredTasks().length)"
      aria-dropeffect="move"
    ></div>

    } @else {
    <!-- ===== EMPTY COLUMN: drop directly on the visible hint; preview replaces it on hover ===== -->
    <div class="empty-drop-wrapper">
      <!-- Overlay slice so the hint itself captures dragover/drop -->
      <div
        class="drop-slice empty-slice"
        [class.active]="sliceIsActive(0)"
        (dragover)="onSliceDragOver($event, 0)"
        (drop)="onSliceDrop($event, 0)"
        aria-dropeffect="move"
      ></div>

      @if (dragOverIndex() === 0 && isTaskDragActive()) {
      <div
        class="task-placeholder open"
        [style.--ph.px]="placeholderHeight()"
        aria-hidden="true"
      >
        @if (ghostTask()) {
        <app-task [task]="ghostTask()!"></app-task>
        }
      </div>
      } @else {
      <div class="empty-column-drop">
        {{ "task.dropHere" | transloco }}
      </div>
      }
    </div>
    }
  </div>
</div>
