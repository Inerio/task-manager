<div
  class="task-card"
  [class.completed]="localTask().completed"
  [class.dragging]="dragging()"
  draggable="true"
  (dragstart)="onDragStart($event)"
  (dragend)="onDragEnd()"
>
  <!-- Badge d'échéance -->
  @if (dueBadge()) {
  <span class="due-badge" [class.late]="dueBadge() === 'En retard !'">
    {{ dueBadge() }}
  </span>
  }

  <!-- Checkbox de statut terminé -->
  <input
    type="checkbox"
    class="task-checkbox-icon"
    [checked]="localTask().completed"
    (change)="toggleCompleted()"
  />

  <!-- Affichage lecture seule -->
  @if (!localTask().isEditing) {
  <div class="task-content-readonly">
    <h4 [innerHTML]="localTask().title | linkify"></h4>
    <p [innerHTML]="localTask().description | linkify"></p>

    <div
      class="attachments-zone"
      (drop)="onFileDrop($event)"
      (dragover)="onDragOverAttachment($event)"
    >
      <div class="attachment-tags">
        @if(localTask().attachments?.length) { @for (filename of
        localTask().attachments ?? []; track filename) {
        <span class="attachment-tag">
          <span
            class="filename"
            (click)="onDownloadAttachment(filename)"
            title="Télécharger"
            >{{ filename }}</span
          >
          <button
            class="remove-btn"
            (click)="onDeleteAttachment(filename)"
            title="Supprimer"
          >
            ✖
          </button>
        </span>
        } }
      </div>
      <label class="upload-label">
        <input
          type="file"
          (change)="onFileSelect($event)"
          [accept]="acceptTypes"
          multiple
          hidden
        />
        <span
          >Glisser/déposer ou
          <span class="fake-link">choisir un fichier</span></span
        >
      </label>
    </div>

    <div class="btn-group">
      <button class="btn btn-success" (click)="startEdit()" title="Modifier">
        Éditer
      </button>
      <button
        class="btn btn-secondary"
        (click)="deleteTask()"
        title="Supprimer"
      >
        Supprimer
      </button>
    </div>
  </div>
  }

  <!-- Édition de la tâche -->
  @else {
  <input
    class="form-control"
    type="text"
    [value]="localTask().title"
    (input)="updateTitleFromEvent($event)"
    placeholder="Titre de la tâche"
    required
    autocomplete="off"
  />
  <textarea
    class="form-control textarea"
    [value]="localTask().description"
    (input)="updateDescriptionFromEvent($event)"
    placeholder="Description"
    required
    rows="4"
  ></textarea>
  <input
    class="form-control"
    type="date"
    [value]="localTask().dueDate ?? ''"
    (input)="updateDueDateFromEvent($event)"
    placeholder="Échéance (optionnelle)"
    autocomplete="off"
  />

  <div
    class="attachments-zone"
    (drop)="onFileDrop($event)"
    (dragover)="onDragOverAttachment($event)"
  >
    <div class="attachment-tags">
      @if(localTask().attachments?.length) { @for (filename of
      localTask().attachments ?? []; track filename) {
      <span class="attachment-tag">
        <span
          class="filename"
          (click)="onDownloadAttachment(filename)"
          title="Télécharger"
          >{{ filename }}</span
        >
        <button
          class="remove-btn"
          (click)="onDeleteAttachment(filename)"
          title="Supprimer"
        >
          ✖
        </button>
      </span>
      } }
    </div>
    <label class="upload-label">
      <input
        type="file"
        (change)="onFileSelect($event)"
        [accept]="acceptTypes"
        multiple
        hidden
      />
      <span
        >Glisser/déposer ou
        <span class="fake-link">choisir un fichier</span></span
      >
    </label>
  </div>

  <div class="btn-group">
    <button class="btn btn-success" (click)="saveEdit()" title="Valider">
      Valider
    </button>
    <button class="btn btn-secondary" (click)="cancelEdit()" title="Annuler">
      Annuler
    </button>
  </div>
  }
</div>
