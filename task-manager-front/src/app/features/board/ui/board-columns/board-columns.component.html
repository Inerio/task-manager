<!-- Dedicated viewport guarantees horizontal scroll on narrow desktop. -->
<div class="columns-viewport">
  <div
    class="task-columns"
    role="list"
    [attr.aria-label]="'boards.columnsAria' | transloco"
    [class.columns-reordering]="dnd.draggedKanbanColumnId() !== null"
  >
    @for (kanbanColumn of kanbanColumns(); track trackByColumnId($index,
    kanbanColumn); let idx = $index) {
    <div
      class="column-draggable"
      role="listitem"
      [class.is-dragged]="dnd.draggedKanbanColumnId() === kanbanColumn.id"
      [class.drag-over]="
        dnd.dragOverIndex() === idx && dnd.draggedKanbanColumnId() !== null
      "
      [class.dropped-pulse]="dnd.columnPulseId() === kanbanColumn.id"
      [class.editing]="isEditingTitle(kanbanColumn)"
      (dragenter)="dnd.onColumnDragHover(idx, $event)"
      (dragover)="dnd.onColumnDragHover(idx, $event)"
      (drop)="dnd.onColumnDrop(boardId, $event)"
    >
      <div
        class="column-header"
        [class.disabled]="
          !!edit.editingColumn() && !isEditingTitle(kanbanColumn)
        "
        [draggable]="!!kanbanColumn.id"
        (dragstart)="dnd.onColumnDragStart(kanbanColumn.id!, idx, $event)"
        (dragenter)="dnd.onColumnDragHover(idx, $event)"
        (dragover)="dnd.onColumnDragHover(idx, $event)"
        (drop)="dnd.onColumnDrop(boardId, $event)"
        (dragend)="dnd.onColumnDragEnd()"
        [attr.aria-grabbed]="
          dnd.draggedKanbanColumnId() === kanbanColumn.id ? 'true' : 'false'
        "
      >
        <!-- Trash first (delete all in column) -->
        @if (kanbanColumn.id) {
        <button
          type="button"
          class="btn-delete-column styled-trash-btn"
          (click)="edit.deleteAllInColumn(kanbanColumn.id!, kanbanColumn.name)"
          [attr.title]="'boards.column.deleteAll' | transloco"
          [disabled]="!!edit.editingColumn() && !isEditingTitle(kanbanColumn)"
        >
          <img
            src="/svg/trash.svg"
            [attr.alt]="'boards.column.deleteAll' | transloco"
            width="19"
            height="19"
          />
        </button>
        } @if (!isEditingTitle(kanbanColumn)) {
        <span
          class="kanbanColumn-title"
          (click)="edit.startEditTitle(kanbanColumn)"
          tabindex="0"
          (keydown.enter)="edit.startEditTitle(kanbanColumn)"
          (keydown.space)="edit.startEditTitle(kanbanColumn)"
          [attr.title]="'boards.column.rename' | transloco"
        >
          @if (!kanbanColumn.name.trim()) {
          <span class="edit-title-placeholder">
            {{ "boards.column.editPlaceholder" | transloco }}
            <img
              src="/svg/pencil.svg"
              [attr.alt]="'common.edit' | transloco"
              class="edit-icon"
            />
          </span>
          } @else { {{ kanbanColumn.name }} }
        </span>
        } @else {
        <input
          id="edit-kanbanColumn-title-{{ kanbanColumn.id ?? 'draft' }}"
          class="kanbanColumn-title-input"
          type="text"
          [value]="edit.editingTitleValue()"
          (input)="edit.onEditTitleInput($event)"
          (blur)="edit.saveTitleEdit(kanbanColumn, boardId)"
          (keydown.enter)="edit.saveTitleEdit(kanbanColumn, boardId)"
          (keydown.escape)="edit.cancelTitleEdit()"
          maxlength="60"
          required
          appAutofocusOnInit
          [disabled]="!!edit.editingColumn() && !isEditingTitle(kanbanColumn)"
        />
        }

        <!-- X button after the title (delete column) -->
        @if (kanbanColumn.id) {
        <button
          type="button"
          class="btn-close-kanbanColumn styled-x-btn"
          (click)="
            edit.deleteKanbanColumn(
              kanbanColumn.id!,
              kanbanColumn.name,
              boardId
            )
          "
          [attr.title]="'boards.column.delete' | transloco"
          aria-label="{{ 'boards.column.delete' | transloco }}"
          [disabled]="!!edit.editingColumn() && !isEditingTitle(kanbanColumn)"
        >
          <img
            src="/svg/x.svg"
            [attr.alt]="'boards.column.delete' | transloco"
            width="17"
            height="17"
          />
        </button>
        }
      </div>

      <!-- Only mount the column component when we have a persisted id. -->
      @if (kanbanColumn.id) {
      <app-kanban-column
        [kanbanColumnId]="kanbanColumn.id!"
        [title]="kanbanColumn.name"
        [hasAnyTask]="hasAnyTask()"
      ></app-kanban-column>
      } @else {
      <div class="task-kanbanColumn empty" aria-hidden="true"></div>
      } @if (!!edit.editingColumn() && !isEditingTitle(kanbanColumn)) {
      <div class="column-blocker"></div>
      }
    </div>
    } @if (kanbanColumns().length < MAX_COLUMNS) {
    <div class="add-column-tile">
      <button
        type="button"
        class="add-kanbanColumn-fab"
        (click)="edit.addKanbanColumnAndEdit(boardId)"
        [attr.title]="'boards.column.add' | transloco"
        aria-label="{{ 'boards.column.add' | transloco }}"
      >
        +
      </button>
    </div>
    }
  </div>
</div>
