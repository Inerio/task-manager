<!-- Template micro-perf: cache expensive reads with @let; remove deprecated aria-dropeffect -->
@let tasks = dnd.displayedTasks(); @let ghost = dnd.ghostTask(); @let isDrag =
dnd.isTaskDragActive(); @let ph = dnd.placeholderHeight();

<div
  #scrollHost
  class="task-kanbanColumn"
  [class.task-drag-active]="isDrag"
  (dragenter)="dnd.onColumnDragEnter($event)"
  (dragleave)="dnd.onColumnDragLeave($event)"
>
  <div class="task-dropzone-column">
    <!-- Add button always on top -->
    <button type="button" (click)="openForm()" class="add-btn">
      + {{ "task.add" | transloco }}
    </button>

    @if (showForm()) {
    <div
      class="task-form-wrapper"
      (mousedown)="$event.stopPropagation()"
      (click)="$event.stopPropagation()"
    >
      <app-task-form
        [task]="{ kanbanColumnId: kanbanColumnId, title: '' }"
        (save)="handleTaskFormSave($event)"
        (cancel)="handleTaskFormCancel()"
      ></app-task-form>
    </div>
    }

    <!-- ===== Non-empty column: head slice + (optional) top preview + tasks + tail slice ===== -->
    @if (tasks.length > 0) {

    <!-- TOP ZONE -->
    <div class="head-zone">
      <!-- Hide the head-slice if it matches the dragged card own edge -->
      @if (!dnd.suppressZone(0)) {
      <div
        class="drop-slice head-slice"
        [class.active]="dnd.sliceIsActive(0)"
        (dragover)="dnd.onSliceDragOver($event, 0)"
        (drop)="dnd.onSliceDrop($event, 0)"
      ></div>
      }

      <div class="head-spacer" aria-hidden="true"></div>

      @if (dnd.dragOverIndex() === 0) {
      <div
        class="task-placeholder"
        [class.open]="dnd.animateOnEnter()"
        [class.open-static]="!dnd.animateOnEnter()"
        [style.--ph.px]="ph"
        aria-hidden="true"
      >
        <!-- Full-area hit target so the whole preview accepts drop -->
        <div
          class="drop-slice placeholder-slice"
          (dragover)="dnd.onSliceDragOver($event, 0)"
          (drop)="dnd.onSliceDrop($event, 0)"
        ></div>

        @if (ghost) {
        <app-task [task]="ghost" [ghost]="true"></app-task>
        }
      </div>
      }
    </div>

    <!-- Inter-task slices + live placeholder -->
    @for (task of tasks; track trackById($index, task); let idx = $index) {
    <div class="task-row">
      <!-- Slice before current card (index = idx); hidden if it's the dragged card own edge -->
      @if (!dnd.suppressZone(idx)) {
      <div
        class="drop-slice slice-before"
        [class.active]="dnd.sliceIsActive(idx)"
        (dragover)="dnd.onSliceDragOver($event, idx)"
        (drop)="dnd.onSliceDrop($event, idx)"
      ></div>
      }

      <app-task [task]="task"></app-task>

      <!-- Live placeholder AFTER this card (index = idx + 1) -->
      @if (dnd.dragOverIndex() === idx + 1) {
      <div
        class="task-placeholder"
        [class.open]="dnd.animateOnEnter()"
        [class.open-static]="!dnd.animateOnEnter()"
        [style.--ph.px]="ph"
        aria-hidden="true"
      >
        <!-- Full-area hit target so the whole preview accepts drop -->
        <div
          class="drop-slice placeholder-slice"
          (dragover)="dnd.onSliceDragOver($event, idx + 1)"
          (drop)="dnd.onSliceDrop($event, idx + 1)"
        ></div>

        @if (ghost) {
        <app-task [task]="ghost" [ghost]="true"></app-task>
        }
      </div>
      }

      <!-- Slice after current card (index = idx + 1); hidden if it's the dragged card own edge -->
      @if (!dnd.suppressZone(idx + 1)) {
      <div
        class="drop-slice slice-after"
        [class.active]="dnd.sliceIsActive(idx + 1)"
        (dragover)="dnd.onSliceDragOver($event, idx + 1)"
        (drop)="dnd.onSliceDrop($event, idx + 1)"
      ></div>
      }
    </div>
    }

    <!-- Tail slice to allow "append" under the last card (index = length) -->
    <div
      class="drop-slice tail-slice"
      [class.active]="dnd.sliceIsActive(tasks.length)"
      (dragover)="dnd.onSliceDragOver($event, tasks.length)"
      (drop)="dnd.onSliceDrop($event, tasks.length)"
    ></div>

    } @else {
    <!-- ===== EMPTY COLUMN: drop directly on the visible hint; preview replaces it on hover ===== -->
    <div class="empty-drop-wrapper">
      <!-- Overlay slice so the hint itself captures dragover/drop -->
      <div
        class="drop-slice empty-slice"
        [class.active]="dnd.sliceIsActive(0)"
        (dragover)="dnd.onSliceDragOver($event, 0)"
        (drop)="dnd.onSliceDrop($event, 0)"
      ></div>

      @if (dnd.dragOverIndex() === 0 && isDrag) {
      <div
        class="task-placeholder"
        [class.open]="dnd.animateOnEnter()"
        [class.open-static]="!dnd.animateOnEnter()"
        [style.--ph.px]="ph"
        aria-hidden="true"
      >
        <!-- Full-area hit target so the whole preview accepts drop -->
        <div
          class="drop-slice placeholder-slice"
          (dragover)="dnd.onSliceDragOver($event, 0)"
          (drop)="dnd.onSliceDrop($event, 0)"
        ></div>

        @if (ghost) {
        <app-task [task]="ghost" [ghost]="true"></app-task>
        }
      </div>
      } @else {
      <div class="empty-column-drop">
        {{ "task.dropHere" | transloco }}
      </div>
      }
    </div>
    }
  </div>
</div>
