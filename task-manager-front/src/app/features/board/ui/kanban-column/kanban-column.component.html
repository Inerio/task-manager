@let tasks = dnd.displayedTasks(); @let ghost = dnd.ghostTask(); @let isDrag =
dnd.isTaskDragActive(); @let ph = dnd.placeholderHeight();

<div
  #scrollHost
  class="task-kanbanColumn"
  [class.task-drag-active]="isDrag"
  (dragenter)="dnd.onColumnDragEnter($event)"
  (dragleave)="dnd.onColumnDragLeave($event)"
>
  <div class="task-dropzone-column">
    <!-- Add button always on top -->
    <button type="button" (click)="openForm()" class="add-btn">
      + {{ "task.add" | transloco }}
    </button>

    @if (showForm()) {
    <div
      class="task-form-wrapper"
      [ensureVisible]="showForm()"
      [evBottomSafe]="300"
      [evRetries]="[0, 120, 260, 420, 700, 1000, 1400]"
      (mousedown)="$event.stopPropagation()"
      (click)="$event.stopPropagation()"
    >
      <app-task-form
        [task]="{ kanbanColumnId: kanbanColumnId, title: '' }"
        (save)="handleTaskFormSave($event)"
        (cancel)="handleTaskFormCancel()"
      ></app-task-form>
    </div>
    } @if (tasks.length > 0) {

    <!-- TOP ZONE -->
    <div class="head-zone">
      @if (!dnd.suppressZone(0)) {
      <div
        class="drop-slice head-slice"
        [class.active]="dnd.sliceIsActive(0)"
        (dragover)="dnd.onSliceDragOver($event, 0)"
        (drop)="dnd.onSliceDrop($event, 0)"
      ></div>
      }

      <div class="head-spacer" aria-hidden="true"></div>

      @if (dnd.dragOverIndex() === 0) {
      <div
        class="task-placeholder"
        [class.open]="dnd.animateOnEnter()"
        [class.open-static]="!dnd.animateOnEnter()"
        [style.--ph.px]="ph"
        aria-hidden="true"
      >
        <div
          class="drop-slice placeholder-slice"
          (dragover)="dnd.onSliceDragOver($event, 0)"
          (drop)="dnd.onSliceDrop($event, 0)"
        ></div>

        @if (ghost) {
        <app-task [task]="ghost" [ghost]="true"></app-task>
        }
      </div>
      }
    </div>
    @for (task of tasks; track trackById($index, task); let idx = $index) {
    <div class="task-row">
      @if (!dnd.suppressZone(idx)) {
      <div
        class="drop-slice slice-before"
        [class.active]="dnd.sliceIsActive(idx)"
        (dragover)="dnd.onSliceDragOver($event, idx)"
        (drop)="dnd.onSliceDrop($event, idx)"
      ></div>
      }
      <app-task [task]="task"></app-task>
      @if (dnd.dragOverIndex() === idx + 1 && idx + 1 < tasks.length) {
      <div
        class="task-placeholder"
        [class.open]="dnd.animateOnEnter()"
        [class.open-static]="!dnd.animateOnEnter()"
        [style.--ph.px]="ph"
        aria-hidden="true"
      >
        <div
          class="drop-slice placeholder-slice"
          (dragover)="dnd.onSliceDragOver($event, idx + 1)"
          (drop)="dnd.onSliceDrop($event, idx + 1)"
        ></div>

        @if (ghost) {
        <app-task [task]="ghost" [ghost]="true"></app-task>
        }
      </div>
      } @if (!dnd.suppressZone(idx + 1) && idx + 1 < tasks.length) {
      <div
        class="drop-slice slice-after"
        [class.active]="dnd.sliceIsActive(idx + 1)"
        (dragover)="dnd.onSliceDragOver($event, idx + 1)"
        (drop)="dnd.onSliceDrop($event, idx + 1)"
      ></div>
      }
    </div>
    }

    <div class="tail-flex-zone">
      <div
        class="drop-slice tail-slice"
        [class.active]="dnd.sliceIsActive(tasks.length)"
        (dragover)="dnd.onSliceDragOver($event, tasks.length)"
        (drop)="dnd.onSliceDrop($event, tasks.length)"
      ></div>

      @if (dnd.dragOverIndex() === tasks.length) {
      <div
        class="task-placeholder"
        [class.open]="dnd.animateOnEnter()"
        [class.open-static]="!dnd.animateOnEnter()"
        [style.--ph.px]="ph"
        aria-hidden="true"
      >
        <div
          class="drop-slice placeholder-slice"
          (dragover)="dnd.onSliceDragOver($event, tasks.length)"
          (drop)="dnd.onSliceDrop($event, tasks.length)"
        ></div>

        @if (ghost) {
        <app-task [task]="ghost" [ghost]="true"></app-task>
        }
      </div>
      }
    </div>

    } @else {
    <!-- ===== EMPTY COLUMN ===== -->
    <div class="empty-drop-wrapper">
      <div
        class="drop-slice empty-slice"
        [class.active]="dnd.sliceIsActive(0)"
        (dragover)="dnd.onSliceDragOver($event, 0)"
        (drop)="dnd.onSliceDrop($event, 0)"
      ></div>

      @if (dnd.dragOverIndex() === 0 && isDrag) {
      <div
        class="task-placeholder"
        [class.open]="dnd.animateOnEnter()"
        [class.open-static]="!dnd.animateOnEnter()"
        [style.--ph.px]="ph"
        aria-hidden="true"
      >
        <div
          class="drop-slice placeholder-slice"
          (dragover)="dnd.onSliceDragOver($event, 0)"
          (drop)="dnd.onSliceDrop($event, 0)"
        ></div>

        @if (ghost) {
        <app-task [task]="ghost" [ghost]="true"></app-task>
        }
      </div>
      } @else {
      <div class="empty-column-drop">
        {{ "task.dropHere" | transloco }}
      </div>
      }
    </div>
    }
  </div>
</div>
