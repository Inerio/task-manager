<div
  #cardEl
  class="task-card"
  [attr.data-testid]="'task-' + localTask().id"
  appTaskPulse
  [appTaskPulseTaskId]="localTask().id ?? null"
  [appTaskPulseGhost]="ghost"
  [appTaskPulseDeferWhile]="dragging()"
  [ensureVisible]="localTask().isEditing === true"
  appTaskDnd
  [appTaskDndTaskId]="localTask().id ?? null"
  [appTaskDndColumnId]="localTask().kanbanColumnId"
  [appTaskDndDisabled]="ghost || localTask().isEditing"
  [appTaskDndGhost]="ghost"
  (taskDraggingChange)="onDndDraggingChange($event)"
  (taskPreviewSize)="onTaskPreviewSize($event)"
  [class.has-badge]="hasDue()"
  [class.completed]="localTask().completed"
  [class.dragging]="dragging()"
  [class.editing]="localTask().isEditing"
>
  <!-- ==== READ-ONLY MODE ==== -->
  @if (!localTask().isEditing) {
  <div class="task-content-readonly">
    @if (!hasDue()) {
    <div class="task-title-row">
      <h4
        appToggleTruncate
        ttMode="overflow"
        [ttContent]="localTask().title"
        [ttResetKey]="localTask().id"
        [ttShowLabelKey]="'task.showFullTitle.show'"
        [ttHideLabelKey]="'task.showFullTitle.hide'"
        class="clamp-title"
        [innerHTML]="localTask().title | linkify"
      ></h4>

      <input
        type="checkbox"
        class="task-checkbox-icon-inline"
        [checked]="localTask().completed"
        (change)="toggleCompleted()"
      />
    </div>
    } @else {
    <app-task-due-badge [dueDate]="localTask().dueDate"></app-task-due-badge>
    <input
      type="checkbox"
      class="task-checkbox-icon"
      [checked]="localTask().completed"
      (change)="toggleCompleted()"
    />
    <h4
      appToggleTruncate
      ttMode="overflow"
      [ttContent]="localTask().title"
      [ttResetKey]="localTask().id"
      [ttShowLabelKey]="'task.showFullTitle.show'"
      [ttHideLabelKey]="'task.showFullTitle.hide'"
      class="clamp-title"
      [innerHTML]="localTask().title | linkify"
    ></h4>
    }

    <p
      appToggleTruncate
      ttMode="overflow"
      [ttContent]="localTask().description"
      [ttResetKey]="localTask().id"
      [ttShowLabelKey]="'task.showFullDescription.show'"
      [ttHideLabelKey]="'task.showFullDescription.hide'"
      class="clamp-desc"
      [innerHTML]="localTask().description | linkify"
    ></p>

    <app-attachment-zone
      [attachments]="localTask().attachments ?? []"
      [taskId]="localTask().id!"
      [acceptTypes]="acceptTypes"
      [maxSize]="maxSize"
      (filesUploaded)="onAttachmentUploaded($event)"
      (fileDeleted)="onAttachmentDeleted($event)"
      (fileDownloaded)="onAttachmentDownloaded($event)"
    ></app-attachment-zone>

    <div class="btn-group">
      <button
        class="btn btn-success"
        data-testid="edit-task"
        (click)="startEdit()"
        [attr.title]="'common.edit' | transloco"
      >
        {{ "common.edit" | transloco }}
      </button>
      <button
        class="btn btn-secondary"
        [attr.title]="'common.delete' | transloco"
        (click)="confirmDelete()"
      >
        {{ "common.delete" | transloco }}
      </button>
    </div>
  </div>
  } @else {
  <!-- ==== EDIT MODE ==== -->
  <app-task-form
    [task]="localTask()"
    [editMode]="true"
    (save)="saveEdit($event)"
    (cancel)="cancelEdit()"
  ></app-task-form>
  }
</div>
