@if (open()) {
<div class="backdrop" (click)="onBackdropClick($event)">
  <div
    class="dialog"
    role="dialog"
    aria-modal="true"
    [attr.aria-labelledby]="'identity.title' | transloco"
  >
    <header class="dialog-header">
      <h3 class="dialog-title">{{ "identity.title" | transloco }}</h3>
      <button
        type="button"
        class="x-btn"
        (click)="onCloseClick()"
        [attr.aria-label]="'common.close' | transloco"
        [title]="'common.close' | transloco"
      >
        <img src="/svg/x.svg" width="16" height="16" alt="x" />
      </button>
    </header>

    <section class="dialog-body">
      <p class="note">
        {{ "identity.note" | transloco }}
      </p>

      <!-- Current Code (22-char Base64URL). No raw UUID displayed anywhere -->
      <div class="row">
        <label class="label">{{
          "identity.currentCodeLabel" | transloco
        }}</label>
        <div class="current-id" [title]="currentCode()">
          {{ currentCode() }}
        </div>
        <button class="btn" type="button" (click)="copyCode()">
          {{
            copied()
              ? ("identity.copied" | transloco)
              : ("identity.copyCode" | transloco)
          }}
        </button>
      </div>

      <!-- Paste a code (accepts code or full UUID) -->
      <div class="row">
        <label class="label" for="uidInput">
          {{ "identity.pasteLabel" | transloco }}
        </label>
        <input
          id="uidInput"
          class="input"
          type="text"
          [placeholder]="'identity.pastePlaceholder' | transloco"
          [formControl]="uidCtrl"
          autocomplete="off"
        />
        @if (codeError()) {
        <div class="error">{{ codeError() }}</div>
        }
      </div>

      <!-- Name to save this code under -->
      <div class="row">
        <label class="label" for="nameInput">
          {{ "identity.nameLabel" | transloco }}
        </label>
        <input
          id="nameInput"
          class="input"
          type="text"
          [placeholder]="'identity.namePlaceholder' | transloco"
          [formControl]="nameCtrl"
          autocomplete="off"
        />
        @if (nameError()) {
        <div class="error">{{ nameError() }}</div>
        }
      </div>

      <!-- Recent named codes -->
      <div class="row history-row">
        <label class="label">{{ "identity.recentLabel" | transloco }}</label>
        <div class="history-list">
          @if (namedHistory().length === 0) {
          <div class="muted">{{ "identity.noRecent" | transloco }}</div>
          } @else { @for (e of namedHistory(); track e.uid) {
          <div class="chip-wrap">
            <button
              type="button"
              class="chip"
              (click)="fillFromHistory(e)"
              [title]="'identity.useThis' | transloco"
            >
              <span class="chip-label">{{ e.label }}</span>
              <span class="chip-code">{{ e.code }}</span>
            </button>

            @if (copiedChip() === e.uid) {
            <span class="copied-hint">{{ "identity.copied" | transloco }}</span>
            }
          </div>
          } }
        </div>
      </div>
    </section>

    <footer class="dialog-actions">
      <button
        class="btn btn-primary"
        type="button"
        (click)="apply()"
        [disabled]="applying() || !uidCtrl.valid || !nameCtrl.valid"
      >
        {{ "identity.useCode" | transloco }}
      </button>
      <button class="btn btn-secondary" type="button" (click)="onCloseClick()">
        {{ "identity.cancel" | transloco }}
      </button>
    </footer>
  </div>
</div>
}
